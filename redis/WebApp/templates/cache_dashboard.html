<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechStore - Cache Performance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 48px;
            font-weight: bold;
            line-height: 1;
        }

        .metric-subtitle {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .hit { color: #10b981; }
        .miss { color: #ef4444; }
        .neutral { color: #3b82f6; }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .comparison-bars {
            display: flex;
            gap: 40px;
            align-items: flex-end;
            height: 300px;
            margin-top: 30px;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bar {
            width: 100%;
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10px;
            color: white;
            font-weight: bold;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .bar.slow {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .bar-label {
            margin-top: 10px;
            font-weight: 600;
            color: #374151;
            text-align: center;
        }

        .bar-sublabel {
            margin-top: 5px;
            font-size: 12px;
            color: #6b7280;
        }

        .progress-ring {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 10;
        }

        .progress-ring .bg {
            stroke: #e5e7eb;
        }

        .progress-ring .progress {
            stroke: #10b981;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: bold;
            color: #10b981;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .updating {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° TechStore - Cache Performance Dashboard</h1>

        <div class="metrics-grid">
            <!-- Cache Hit Rate -->
            <div class="metric-card">
                <div class="metric-label">Cache Hit Rate</div>
                <div class="progress-ring">
                    <svg width="150" height="150">
                        <circle class="bg" cx="75" cy="75" r="65"></circle>
                        <circle class="progress" cx="75" cy="75" r="65"
                                stroke-dasharray="408.4"
                                stroke-dashoffset="408.4"
                                id="hitRateCircle"></circle>
                    </svg>
                    <div class="progress-value" id="hitRateValue">0%</div>
                </div>
                <div class="metric-subtitle">Objetivo: >90%</div>
            </div>

            <!-- Total Requests -->
            <div class="metric-card">
                <div class="metric-label">Total de Consultas</div>
                <div class="metric-value neutral" id="totalRequests">0</div>
                <div class="metric-subtitle">Hits + Misses</div>
            </div>

            <!-- Cache Hits -->
            <div class="metric-card">
                <div class="metric-label">Cache Hits</div>
                <div class="metric-value hit" id="cacheHits">0</div>
                <div class="metric-subtitle">‚úì Servidas desde Redis</div>
            </div>

            <!-- Cache Misses -->
            <div class="metric-card">
                <div class="metric-label">Cache Misses</div>
                <div class="metric-value miss" id="cacheMisses">0</div>
                <div class="metric-subtitle">‚ö† Consultadas a BD</div>
            </div>
        </div>

        <!-- Comparaci√≥n de Latencia -->
        <div class="chart-container">
            <h2 style="margin-bottom: 10px; color: #374151;">‚ö° Comparaci√≥n de Latencia</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Redis Cache vs Base de Datos Tradicional (SQLite)</p>

            <div class="comparison-bars">
                <div class="bar-group">
                    <div class="bar" style="height: 5%;" id="cacheBar">
                        <span>~2ms</span>
                    </div>
                    <div class="bar-label">üöÄ Redis Cache</div>
                    <div class="bar-sublabel">En memoria, ultra r√°pido</div>
                </div>

                <div class="bar-group">
                    <div class="bar slow" style="height: 100%;" id="dbBar">
                        <span>~150ms</span>
                    </div>
                    <div class="bar-label">üêå SQLite Database</div>
                    <div class="bar-sublabel">Acceso a disco, m√°s lento</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                <strong style="color: #10b981; font-size: 24px;">75x m√°s r√°pido</strong>
                <p style="color: #6b7280; margin-top: 5px;">Redis reduce la latencia en un 98%</p>
            </div>
        </div>

        <!-- Estado del Sistema -->
        <div class="chart-container">
            <h2 style="margin-bottom: 20px; color: #374151;">üìä Estado del Sistema</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Redis Cache</div>
                    <span class="status-badge status-connected" id="cacheStatus">Conectado</span>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Memoria Usada</div>
                    <span style="font-weight: 600;" id="memoryUsed">-</span>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Invalidaciones</div>
                    <span style="font-weight: 600;" id="invalidations">0</span>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Errores</div>
                    <span style="font-weight: 600;" id="errors">0</span>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="warmupCache()">üî• Pre-calentar Cach√©</button>
                <button class="btn btn-danger" onclick="invalidateCache()">üóëÔ∏è Limpiar Cach√©</button>
                <button class="btn btn-primary" onclick="resetStats()">üîÑ Resetear Stats</button>
            </div>
        </div>
    </div>

    <script>
        // Actualizar m√©tricas cada 2 segundos
        async function updateMetrics() {
            try {
                const response = await fetch('/api/cache/stats');
                const data = await response.json();

                if (data.cache_stats) {
                    const stats = data.cache_stats;

                    // Actualizar valores
                    document.getElementById('hitRateValue').textContent = stats.hit_rate + '%';
                    document.getElementById('totalRequests').textContent = stats.total_requests.toLocaleString();
                    document.getElementById('cacheHits').textContent = stats.hits.toLocaleString();
                    document.getElementById('cacheMisses').textContent = stats.misses.toLocaleString();
                    document.getElementById('invalidations').textContent = (stats.invalidations || 0).toLocaleString();
                    document.getElementById('errors').textContent = (stats.errors || 0).toLocaleString();

                    // Actualizar c√≠rculo de progreso
                    const circle = document.getElementById('hitRateCircle');
                    const circumference = 408.4;
                    const offset = circumference - (stats.hit_rate / 100 * circumference);
                    circle.style.strokeDashoffset = offset;

                    // Cambiar color seg√∫n hit rate
                    if (stats.hit_rate >= 90) {
                        circle.style.stroke = '#10b981'; // Verde
                        document.getElementById('hitRateValue').style.color = '#10b981';
                    } else if (stats.hit_rate >= 70) {
                        circle.style.stroke = '#f59e0b'; // Naranja
                        document.getElementById('hitRateValue').style.color = '#f59e0b';
                    } else {
                        circle.style.stroke = '#ef4444'; // Rojo
                        document.getElementById('hitRateValue').style.color = '#ef4444';
                    }

                    // Estado de conexi√≥n
                    const statusBadge = document.getElementById('cacheStatus');
                    if (stats.status === 'connected') {
                        statusBadge.textContent = 'Conectado';
                        statusBadge.className = 'status-badge status-connected';
                    } else {
                        statusBadge.textContent = 'Desconectado';
                        statusBadge.className = 'status-badge status-disconnected';
                    }
                }

                if (data.redis_info && data.redis_info.used_memory_human) {
                    document.getElementById('memoryUsed').textContent = data.redis_info.used_memory_human;
                }

            } catch (error) {
                console.error('Error actualizando m√©tricas:', error);
            }
        }

        async function warmupCache() {
            try {
                const response = await fetch('/api/cache/warmup', { method: 'POST' });
                const data = await response.json();
                alert('‚úì ' + data.message);
                updateMetrics();
            } catch (error) {
                alert('‚úó Error: ' + error.message);
            }
        }

        async function invalidateCache() {
            if (!confirm('¬øEst√°s seguro de que quieres limpiar toda la cach√©?')) {
                return;
            }

            try {
                const response = await fetch('/api/cache/invalidate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'all' })
                });
                const data = await response.json();
                alert('‚úì ' + data.message);
                updateMetrics();
            } catch (error) {
                alert('‚úó Error: ' + error.message);
            }
        }

        async function resetStats() {
            if (!confirm('¬øResetear las estad√≠sticas de cach√©?')) {
                return;
            }

            try {
                // No hay endpoint para esto a√∫n, pero puedes agregarlo
                alert('‚úì Estad√≠sticas reseteadas (funcionalidad pendiente)');
            } catch (error) {
                alert('‚úó Error: ' + error.message);
            }
        }

        // Iniciar actualizaci√≥n autom√°tica
        updateMetrics();
        setInterval(updateMetrics, 2000);
    </script>
</body>
</html>
