version: '3.8'

services:
  # Redis Master (principal)
  redis-master:
    image: redis:7-alpine
    container_name: redis-master
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass myredispassword
    volumes:
      - redis-master-data:/data
    networks:
      - redis-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredispassword", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Replica 1
  redis-replica-1:
    image: redis:7-alpine
    container_name: redis-replica-1
    ports:
      - "6380:6379"
    command: redis-server --replicaof redis-master 6379 --masterauth myredispassword --requirepass myredispassword
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredispassword", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Replica 2
  redis-replica-2:
    image: redis:7-alpine
    container_name: redis-replica-2
    ports:
      - "6381:6379"
    command: redis-server --replicaof redis-master 6379 --masterauth myredispassword --requirepass myredispassword
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredispassword", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Aplicación Web - CacheSimulator
  webapp:
    build:
      context: ./redis/CacheSimulator
      dockerfile: Dockerfile
    container_name: techstore-webapp
    ports:
      - "5000:5000"
    environment:
      # Redis LOCAL para caché
      - REDIS_LOCAL_HOST=redis-master
      - REDIS_LOCAL_PORT=6379
      - REDIS_LOCAL_PASSWORD=myredispassword
      # Redis CLOUD para métricas
      - REDIS_CLOUD_HOST=redis-15381.c92.us-east-1-3.ec2.cloud.redislabs.com
      - REDIS_CLOUD_PORT=15381
      - REDIS_CLOUD_PASSWORD=yHxDNbPJx8HWPjuuYrqswVkzwlhZdiT3
      - FLASK_ENV=development
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-network
    volumes:
      - ./redis/CacheSimulator:/app

  # Dashboard de Métricas - Lee de Redis CLOUD
  metrics-dashboard:
    build:
      context: ./redis/MetricsGenerator
      dockerfile: Dockerfile
    container_name: metrics-dashboard
    ports:
      - "8050:8050"
    environment:
      # Redis CLOUD para leer métricas (usuario: metrics_reader)
      - REDIS_CLOUD_HOST=redis-15381.c92.us-east-1-3.ec2.cloud.redislabs.com
      - REDIS_CLOUD_PORT=15381
      - REDIS_CLOUD_USER=metrics_reader
      - REDIS_CLOUD_PASSWORD=Metrics_reader_pass_2025
      # Fallback a LOCAL si falla CLOUD
      - REDIS_HOST=redis-master
      - REDIS_PORT=6379
      - REDIS_PASSWORD=myredispassword
    networks:
      - redis-network
    volumes:
      - ./redis/MetricsGenerator:/app

  # Generador de Muestras - Escribe en Redis CLOUD
  samples-generator:
    build:
      context: ./redis/SamplesGenerator
      dockerfile: Dockerfile
    container_name: samples-generator
    environment:
      # Redis CLOUD para escribir métricas (usuario: metrics_writer)
      - REDIS_CLOUD_HOST=redis-15381.c92.us-east-1-3.ec2.cloud.redislabs.com
      - REDIS_CLOUD_PORT=15381
      - REDIS_CLOUD_USER=metrics_writer
      - REDIS_CLOUD_PASSWORD=Metrics_writer_pass_2025
      # Fallback a LOCAL si falla CLOUD
      - REDIS_HOST=redis-master
      - REDIS_PORT=6379
      - REDIS_PASSWORD=myredispassword
    networks:
      - redis-network
    volumes:
      - ./redis/SamplesGenerator:/app

networks:
  redis-network:
    driver: bridge

volumes:
  redis-master-data:
